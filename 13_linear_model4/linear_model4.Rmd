---
title: "Class 13"
author: "Tobias Gerstenberg"
date: "February 6th, 2019"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 4
    theme: cosmo
    highlight: tango
    pandoc_args: ["--number-offset=12"]
bibliography: [packages.bib]
nocite: '@*'
---

```{r setup, include=FALSE}
# these options here change the formatting of how comments are rendered
knitr::opts_chunk$set(
  comment = "",
  results = "hold",
  fig.show = "hold")
```

# Linear model 4

```{r install-packages, include=FALSE, eval=FALSE}
# install.packages("afex")
```

## Load packages and set plotting theme  

```{r load-packages, message=FALSE}
library("knitr")      # for knitting RMarkdown 
library("kableExtra") # for making nice tables
library("janitor")    # for cleaning column names
library("broom")    # for tidying up linear models 
library("afex")    # for running ANOVAs
library("emmeans")    # for calculating constrasts
library("car")    # for calculating ANOVAs
library("tidyverse")  # for wrangling, plotting, etc.

# include references for used packages
knitr::write_bib(.packages(), "packages.bib") 
```

```{r set-theme}
theme_set(
  theme_classic() + #set the theme 
    theme(text = element_text(size = 20)) #set the default text size
)
```

## Understanding variance

### Poker data set 

Read in the data:

```{r}
df.poker = read_csv("data/poker.csv") %>% 
  mutate(skill = factor(skill,
                        levels = 1:2,
                        labels = c("expert", "average")),
         skill = fct_relevel(skill, "average", "expert"),
         hand = factor(hand,
                       levels = 1:3,
                       labels = c("bad", "neutral", "good")),
         limit = factor(limit,
                        levels = 1:2,
                        labels = c("fixed", "none")),
         participant = 1:n()) %>% 
  select(participant, everything()) %>% 
  filter(!participant %in% 1:10) %>%
  identity()
```

### One-way ANOVA

Run the model:

```{r}
fit1 = lm(formula = balance ~ hand, 
         data = df.poker)

fit1 %>%
  anova()

lm(formula = balance ~ hand, 
   data = df.poker) %>% 
  anova()
```

#### Variance decomposition

##### Calculation

Understand how the variance is broken down:  

```{r}
df.poker %>% 
  mutate(mean_grand = mean(balance)) %>% 
  group_by(hand) %>% 
  mutate(mean_group = mean(balance)) %>% 
  ungroup() %>% 
  summarize(variance_total = sum((balance - mean_grand)^2),
            variance_model = sum((mean_group - mean_grand)^2),
            variance_residual = variance_total - variance_model)
```

Data frame to show: 

```{r}
df.poker %>% 
  mutate(mean_grand = mean(balance)) %>% 
  group_by(hand) %>% 
  mutate(mean_group = mean(balance)) %>% 
  group_by(hand) %>% 
  filter(row_number() < 4) %>% 
  select(participant, hand, balance, contains("mean")) %>% 
    head(10) %>% 
    kable(digits = 3) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
```


```{r}
df.poker %>% 
  mutate(mean_grand = mean(balance)) %>% 
  group_by(hand) %>% 
  mutate(mean_group = mean(balance)) %>% 
  ungroup() %>% 
  summarize(variance_total = sum((balance - mean_grand)^2),
            variance_model = sum((mean_group - mean_grand)^2),
            variance_residual = variance_total - variance_model)%>% 
              head(10) %>% 
              kable(digits = 0) %>% 
              kable_styling(bootstrap_options = "striped",
                          full_width = F)
            
```

##### Visualization

Total variance

```{r}
set.seed(1)

fit_c = lm(formula = balance ~ 1,
           data = df.poker)

df.plot = df.poker %>% 
  mutate(hand_jitter = 1 + runif(n(), min = -0.25, max = 0.25))

df.augment = fit_c %>% 
  augment() %>% 
  clean_names() %>% 
  bind_cols(df.plot %>% select(balance, hand, hand_jitter))

ggplot(data = df.plot, 
       mapping = aes(x = hand_jitter,
                       y = balance,
                       fill = hand)) + 
  geom_hline(yintercept = mean(df.poker$balance)) +
  geom_point(alpha = 0.5) + 
  geom_segment(data = df.augment,
               aes(xend = hand_jitter,
                   yend = fitted),
               alpha = 0.2) +
  labs(y = "balance") + 
  theme(legend.position = "none",
        axis.text.x = element_blank(),
        axis.title.x = element_blank())

```

Model variance

```{r}
set.seed(1)

df.plot = df.poker %>% 
  mutate(hand_jitter = hand %>% as.numeric(),
         hand_jitter = hand_jitter + runif(n(), min = -0.4, max = 0.4)) %>% 
  group_by(hand) %>% 
  mutate(mean_group = mean(balance)) %>% 
  ungroup() %>% 
  mutate(mean_grand = mean(balance))
  
df.means = df.poker %>% 
  group_by(hand) %>% 
  summarize(mean = mean(balance)) %>% 
  spread(hand, mean)

ggplot(data = df.plot,
       mapping = aes(x = hand_jitter,
                       y = mean_group,
                       color = hand)) + 
  geom_point(alpha = 0.8) +
  geom_segment(data = NULL,
               aes(x = 0.6,
                   xend = 1.4,
                   y = df.means$bad,
                   yend = df.means$bad
                   ),
               color = "red",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 1.6,
                   xend = 2.4,
                   y = df.means$neutral,
                   yend = df.means$neutral
                   ),
               color = "orange",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 2.6,
                   xend = 3.4,
                   y = df.means$good,
                   yend = df.means$good
                   ),
               color = "green",
               size = 1) +
  geom_segment(aes(xend = hand_jitter,
                   y = mean_group,
                   yend = mean_grand),
               alpha = 0.3) +
  geom_hline(yintercept = mean(df.poker$balance),
             size = 1) + 
  labs(y = "balance") + 
  scale_color_manual(values = c("red", "orange", "green")) + 
  scale_x_continuous(breaks = 1:3, labels = c("bad", "neutral", "good")) + 
  scale_y_continuous(breaks = c(0, 10, 20), labels = c(0, 10, 20), limits = c(0, 25)) + 
  theme(legend.position = "none",
        axis.title.x = element_blank())

```

Residual variance 

```{r}
set.seed(1)

fit_a = lm(formula = balance ~ hand,
           data = df.poker)

df.plot = df.poker %>% 
  mutate(hand_jitter = hand %>% as.numeric(),
         hand_jitter = hand_jitter + runif(n(), min = -0.4, max = 0.4))

df.tidy = fit_a %>% 
  tidy() %>% 
  select_if(is.numeric) %>% 
  mutate_all(funs(round, .args = list(digits = 2)))

df.augment = fit_a %>% 
  augment() %>%
  clean_names() %>% 
  bind_cols(df.plot %>% select(hand_jitter))

ggplot(data = df.plot,
       mapping = aes(x = hand_jitter,
                       y = balance,
                       color = hand)) + 
  geom_point(alpha = 0.8) +
  geom_segment(data = NULL,
               aes(x = 0.6,
                   xend = 1.4,
                   y = df.tidy$estimate[1],
                   yend = df.tidy$estimate[1]
                   ),
               color = "red",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 1.6,
                   xend = 2.4,
                   y = df.tidy$estimate[1] + df.tidy$estimate[2],
                   yend = df.tidy$estimate[1] + df.tidy$estimate[2]
                   ),
               color = "orange",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 2.6,
                   xend = 3.4,
                   y = df.tidy$estimate[1] + df.tidy$estimate[3],
                   yend = df.tidy$estimate[1] + df.tidy$estimate[3]
                   ),
               color = "green",
               size = 1) +
  geom_segment(data = df.augment,
               aes(xend = hand_jitter,
                   y = balance,
                   yend = fitted),
               alpha = 0.3) +
  labs(y = "balance") + 
  scale_color_manual(values = c("red", "orange", "green")) + 
  scale_x_continuous(breaks = 1:3, labels = c("bad", "neutral", "good")) + 
  theme(legend.position = "none",
        axis.title.x = element_blank())
```


#### Two-way ANOVA (linear model)

```{r}
fit2 = lm(formula = balance ~ hand + skill, 
         data = df.poker)

fit2 %>%
  anova()

# lm(formula = balance ~ hand + skill, data = df.poker) %>% 
#   anova()
```

##### Calculation 

```{r}
df.poker %>% 
  mutate(mean_grand = mean(balance)) %>% 
  group_by(skill) %>% 
  mutate(mean_skill = mean(balance)) %>%
  group_by(hand) %>% 
  mutate(mean_hand = mean(balance)) %>%
  ungroup() %>%
  summarize(variance_total = sum((balance - mean_grand)^2),
            variance_skill = sum((mean_skill - mean_grand)^2),
            variance_hand = sum((mean_hand - mean_grand)^2),
            variance_residual = variance_total - variance_skill - variance_hand)
```

Data frame to show: 

```{r}
df.poker %>% 
  mutate(mean_grand = mean(balance)) %>% 
  group_by(skill) %>% 
  mutate(mean_skill = mean(balance)) %>%
  group_by(hand) %>% 
  mutate(mean_hand = mean(balance)) %>%
  group_by(hand, skill) %>% 
  filter(row_number() < 3) %>% 
  select(participant, skill, hand, balance, contains("mean")) %>% 
    head(10) %>% 
    kable(digits = 2) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
```

```{r}
df.poker %>% 
  mutate(mean_grand = mean(balance)) %>% 
  group_by(skill) %>% 
  mutate(mean_skill = mean(balance)) %>%
  group_by(hand) %>% 
  mutate(mean_hand = mean(balance)) %>%
  ungroup() %>%
  summarize(variance_total = sum((balance - mean_grand)^2),
            variance_skill = sum((mean_skill - mean_grand)^2),
            variance_hand = sum((mean_hand - mean_grand)^2),
            variance_residual = variance_total - variance_skill - variance_hand
            ) %>% 
              head(1) %>% 
              kable(digits = 0) %>% 
              kable_styling(bootstrap_options = "striped",
                          full_width = F)
            
```

##### Visualization

Model skill: 

```{r}
set.seed(1)

df.plot = df.poker %>% 
  mutate(skill_jitter = skill %>% as.numeric(),
         skill_jitter = skill_jitter + runif(n(), min = -0.4, max = 0.4)) %>% 
  group_by(skill) %>% 
  mutate(mean_group = mean(balance)) %>% 
  ungroup() %>% 
  mutate(mean_grand = mean(balance))
  
df.means = df.poker %>% 
  group_by(skill) %>% 
  summarize(mean = mean(balance)) %>% 
  spread(skill, mean)

ggplot(data = df.plot,
       mapping = aes(x = skill_jitter,
                       y = mean_group,
                       color = skill)) + 
  geom_point(alpha = 0.8) +
  geom_segment(data = NULL,
               aes(x = 0.6,
                   xend = 1.4,
                   y = df.means$average,
                   yend = df.means$average
                   ),
               color = "black",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 1.6,
                   xend = 2.4,
                   y = df.means$expert,
                   yend = df.means$expert
                   ),
               color = "gray50",
               size = 1) +
  geom_segment(aes(xend = skill_jitter,
                   y = mean_group,
                   yend = mean_grand),
               alpha = 0.3) +
  geom_hline(yintercept = mean(df.poker$balance),
             size = 1) + 
  labs(y = "balance") + 
  scale_color_manual(values = c("black", "gray50")) + 
  scale_x_continuous(breaks = 1:2, labels = c("average", "expert")) + 
  scale_y_continuous(breaks = c(0, 10, 20), labels = c(0, 10, 20), limits = c(0, 25)) +
  theme(legend.position = "none",
        axis.title.x = element_blank())

```


##### Unequal cell sizes  

order dependence of independent variables (when the IVs are correlated): 

```{r}
fit2 = lm(formula = balance ~ skill + hand, 
         data = df.poker)

fit2 %>%
  anova()

# fit2 %>%
#   Anova(type = "3")
```


```{r}
lm(formula = balance ~ hand + skill, data = df.poker) %>% 
  anova()
```

```{r}
library("car")

lm(formula = balance ~ hand + skill,
   data = df.poker,
   contrasts = list(hand = "contr.sum", 
                    skill = "contr.sum")) %>% 
  Anova(type = "3")
```

```{r}
lm(formula = balance ~ skill + hand,
   data = df.poker,
   contrasts = list(hand = "contr.sum", 
                    skill = "contr.sum")) %>% 
  Anova(type = "3")
```






```{r}
fit2 = lm(formula = balance ~ hand + skill, 
         data = df.poker)

# fit2 %>%
#   anova()

fit2 %>%
  Anova(type = "3")
```

Unequal group sizes

```{r}
df.poker %>% 
  mutate(mean_grand = mean(balance)) %>% 
  group_by(skill) %>% 
  mutate(size_skill = n(),
    mean_skill = sum(balance)/n()) %>%
  group_by(hand) %>% 
  ungroup() %>%
  summarize(variance_total = sum((balance - mean_grand)^2),
            variance_skill = sum((mean_skill - mean_grand)^2),
            variance_hand = sum((mean_hand - mean_grand)^2),
            variance_residual = variance_total - variance_skill - variance_hand
            )
```

```{r}
library("afex")

fit = aov_ez(id = "participant",
             dv = "balance",
             data = df.poker,
             between = c("hand", "skill"))
fit$Anova
```



#### Two-way ANOVA (with interaction)

```{r}
fit3 = lm(formula = balance ~ hand * skill, data = df.poker)
fit3 %>% 
  anova()
```

```{r}
df.poker %>% 
  mutate(mean_grand = mean(balance)) %>% 
  group_by(skill) %>% 
  mutate(mean_skill = mean(balance)) %>% 
  group_by(hand) %>% 
  mutate(mean_hand = mean(balance)) %>%
  group_by(hand, skill) %>% 
  mutate(mean_hand_skill = mean(balance)) %>%
  ungroup() %>%
  summarize(variance_total = sum((balance - mean_grand)^2),
            variance_skill = sum((mean_skill - mean_grand)^2),
            variance_hand = sum((mean_hand - mean_grand)^2),
            variance_hand_skill = sum((mean_hand_skill - mean_skill - mean_hand + mean_grand)^2),
            variance_residual = variance_total - variance_skill - variance_hand - variance_hand_skill
            )
```

```{r}
fit3 = lm(formula = balance ~ hand * skill,
         data = df.poker,
         contrasts = c("contr.sum", "contr.sum"))

# fit3 = lm(formula = balance ~ hand * skill,
#          data = df.poker)
# 

fit3 %>%
  Anova(type = "3")

# fit3 %>%
#   anova()
```

```{r}
fit3 = lm(formula = balance ~ skill * hand,
         data = df.poker,
         # contrasts = c("contr.sum","contr.poly"))
         contrasts = c("contr.sum", "contr.poly"))

# fit3 = lm(formula = balance ~ hand * skill,
#          data = df.poker)
# 

fit3 %>%
  Anova(type = "3")
```

MWE of difference between car and afex. 

```{r}
library("tidyverse")
library("car")
library("afex")

df.cars = mtcars %>% 
  mutate(index = 1:n()) %>% 
  mutate_at(vars(vs, am), funs(as.factor))

fit1 = lm(formula = mpg ~ vs * am,
         data = df.cars,
         contrasts = c("contr.sum", "contr.poly"))

fit1 %>%
  Anova(type = "3")

fit2 = aov_ez(id = "index",
       dv = "mpg",
       data = df.cars,
       between = c("vs", "am"))
fit2$Anova
```

### Contrasts 

```{r}
df.poker = df.poker %>% 
  mutate(hand_contrast = factor(hand,
                                levels = c("bad", "neutral", "good"),
                                labels = c(-1, 0, 1)),
         hand_contrast = hand_contrast %>% as.character() %>% as.numeric())

fit.contrast = lm(formula = balance ~ hand_contrast,
         data = df.poker)

fit.contrast %>% summary()
```

```{r}
df.poker %>% 
  mutate(hand_contrast = factor(hand,
                                levels = c("bad", "neutral", "good"),
                                labels = c(-1, 0, 1)),
         hand_contrast = hand_contrast %>% as.character() %>% as.numeric()) %>% 
  select(participant, hand, balance, contains("_")) %>% 
  group_by(hand) %>% 
  filter(row_number() < 4) %>% 
           # head(n) %>% 
           kable(digits = 2) %>% 
           kable_styling(bootstrap_options = "striped",
                       full_width = F)
```

Prediction by linear contrast 

```{r}
df.plot = df.poker %>% 
  mutate(hand_jitter = hand %>% as.numeric(),
         hand_jitter = hand_jitter + runif(n(), min = -0.4, max = 0.4))

df.tidy = fit.contrast %>% 
  tidy() %>% 
  select_if(is.numeric) %>% 
  mutate_all(funs(round, .args = list(digits = 2)))

df.augment = fit.contrast %>% 
  augment() %>%
  clean_names() %>% 
  bind_cols(df.plot %>% select(hand_jitter))

ggplot(data = df.plot,
       mapping = aes(x = hand_jitter,
                       y = balance,
                       color = as.factor(hand_contrast))) + 
  geom_point(alpha = 0.8) +
  geom_segment(data = NULL,
               aes(x = 0.6,
                   xend = 1.4,
                   y = df.tidy$estimate[1]-df.tidy$estimate[2],
                   yend = df.tidy$estimate[1]-df.tidy$estimate[2]
                   ),
               color = "red",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 1.6,
                   xend = 2.4,
                   y = df.tidy$estimate[1],
                   yend = df.tidy$estimate[1]
                   ),
               color = "orange",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 2.6,
                   xend = 3.4,
                   y = df.tidy$estimate[1] + df.tidy$estimate[2],
                   yend = df.tidy$estimate[1] + df.tidy$estimate[2]
                   ),
               color = "green",
               size = 1) +
  geom_segment(data = df.augment,
               aes(xend = hand_jitter,
                   y = balance,
                   yend = fitted),
               alpha = 0.3) +
  labs(y = "balance") + 
  scale_color_manual(values = c("red", "orange", "green")) + 
  scale_x_continuous(breaks = 1:3, labels = c("bad", "neutral", "good")) + 
  theme(legend.position = "none",
        axis.title.x = element_blank())
```


```{r}
fit.contrast %>% 
  tidy() %>% 
  select_if(is.numeric) %>% 
  mutate_all(funs(round, .args = list(digits = 2))) %>% 
  mutate(name = c("intercept", "contrast")) %>% 
  select(name, everything()) %>% 
    head(10) %>% 
    kable(digits = 3) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
  

```


#### Hypothetical data 

```{r}
# make example reproducible 
set.seed(1)

# means = c(5, 10, 5)
means = c(3, 5, 20)
# means = c(3, 5, 7)
# means = c(3, 7, 12)
sd = 2
sample_size = 20

# generate data 
df.contrast = tibble(
  group = rep(c("3-4", "5-6", "10+"), each = sample_size),
  performance = NA) %>% 
  mutate(performance = ifelse(group == "3-4",
                              rnorm(sample_size,
                                    mean = means[1],
                                    sd = sd),
                              performance),
         
         performance = ifelse(group == "5-6",
                              rnorm(sample_size,
                                    mean = means[2],
                                    sd = sd),
                              performance),
         performance = ifelse(group == "10+",
                              rnorm(sample_size,
                                    mean = means[3],
                                    sd = sd),
                              performance),
         group = factor(group, levels = c("3-4", "5-6", "10+")),
         group_contrast = group %>% 
           fct_recode(`-1` = "3-4",
                      `0` = "5-6",
                      `1` = "10+") %>% 
           as.character() %>%
           as.numeric())
```


```{r}
# lm(formula = performance ~ group,
lm(formula = performance ~ group_contrast,
   data = df.contrast) %>% 
  summary()
```

Linear contrast

```{r}
fit5 = lm(formula = performance ~ group,
   data = df.contrast)

# define the contrasts of interest 
contrasts = list(linear = c(-1, 0, 1))

# compute estimated marginal means
leastsquare = emmeans(fit5, "group")

# run follow-up analyses
contrast(leastsquare,
         contrasts,
         adjust = "bonferroni")
```



Linear and exponential contrast 

```{r}
fit6 = lm(formula = performance ~ group_contrast + I(group_contrast^2),
   data = df.contrast)

fit6 %>% 
  augment(newdata = tibble(group_contrast = c(-1, 0, 1)))

# define the contrasts of interest 
contrasts = list(linear = c(-1, 0, 1),
                 quadratic = c(1, 0, 1))

# compute estimated marginal means
leastsquare = emmeans(fit5, "group")

# run follow-up analyses
contrast(leastsquare,
         contrasts,
         adjust = "bonferroni")
```

#### Visualization

Total variance 

```{r}
set.seed(1)

fit_c = lm(formula = performance ~ 1,
           data = df.contrast)

df.plot = df.contrast %>% 
  mutate(group_jitter = 1 + runif(n(), min = -0.25, max = 0.25))

df.augment = fit_c %>% 
  augment() %>% 
  clean_names() %>% 
  bind_cols(df.plot %>% select(performance, group, group_jitter))

ggplot(data = df.plot, 
       mapping = aes(x = group_jitter,
                       y = performance,
                       fill = group)) + 
  geom_hline(yintercept = mean(df.contrast$performance)) +
  geom_point(alpha = 0.5) + 
  geom_segment(data = df.augment,
               aes(xend = group_jitter,
                   yend = fitted),
               alpha = 0.2) +
  labs(y = "performance") + 
  theme(legend.position = "none",
        axis.text.x = element_blank(),
        axis.title.x = element_blank())

```


With contrast

```{r}
# make example reproducible 
set.seed(1)

# fit = lm(formula = performance ~ group_contrast,
# fit = lm(formula = performance ~ I(group_contrast^2),
fit = lm(formula = performance ~ group_contrast + I(group_contrast^2),
         data = df.contrast)

df.plot = df.contrast %>% 
  mutate(group_jitter = group %>% as.numeric(),
         group_jitter = group_jitter + runif(n(), min = -0.4, max = 0.4))

df.tidy = fit %>% 
  tidy() %>% 
  select_if(is.numeric) %>% 
  mutate_all(funs(round, .args = list(digits = 2)))

df.augment = fit %>% 
  augment() %>%
  clean_names() %>% 
  bind_cols(df.plot %>% select(group_jitter, group_contrast))

ggplot(data = df.plot,
       mapping = aes(x = group_jitter,
                       y = performance,
                       color = as.factor(group_contrast))) + 
  geom_point(alpha = 0.8) +
  geom_segment(data = NULL,
               aes(x = 0.6,
                   xend = 1.4,
                   y = df.tidy$estimate[1]-df.tidy$estimate[2],
                   yend = df.tidy$estimate[1]-df.tidy$estimate[2]
                   # y = df.tidy$estimate[1]+df.tidy$estimate[2],
                   # yend = df.tidy$estimate[1]+df.tidy$estimate[2]
                   ),
               color = "red",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 1.6,
                   xend = 2.4,
                   y = df.tidy$estimate[1],
                   yend = df.tidy$estimate[1]
                   ),
               color = "orange",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 2.6,
                   xend = 3.4,
                   y = df.tidy$estimate[1] + df.tidy$estimate[2],
                   yend = df.tidy$estimate[1] + df.tidy$estimate[2]
                   ),
               color = "green",
               size = 1) +
  geom_segment(data = df.augment,
               aes(xend = group_jitter,
                   y = performance,
                   yend = fitted),
               alpha = 0.3) +
  labs(y = "balance") + 
  scale_color_manual(values = c("red", "orange", "green")) + 
  scale_x_continuous(breaks = 1:3, labels = levels(df.contrast$group)) +
  theme(legend.position = "none",
        axis.title.x = element_blank())
```


```{r}
# make example reproducible 
set.seed(1)

df.contrast = df.contrast %>% 
  mutate(age = factor(group, labels = c(3.5, 4.5, 11)) %>% as.character() %>% as.numeric())

fit = lm(formula = performance ~ group_contrast + I(group_contrast^2),
# fit = lm(formula = performance ~ age,
# fit = lm(formula = performance ~ I(group_contrast^2),
         data = df.contrast)

fit %>% summary()

df.plot = df.contrast %>% 
  mutate(group_jitter = group %>% as.numeric(),
         group_jitter = group_jitter + runif(n(), min = -0.4, max = 0.4))

df.prediction = fit %>% 
  # augment(newdata = tibble(group_contrast = c(-1, 0, 1))) %>% 
  augment(newdata = tibble(age = c(3.5, 4.5, 11))) %>% 
  clean_names()

df.augment = fit %>% 
  augment() %>%
  clean_names() %>% 
  # bind_cols(df.plot %>% select(group_jitter, group_contrast))
  bind_cols(df.plot %>% select(group_jitter, group_contrast, age))

ggplot(data = df.plot,
       mapping = aes(x = group_jitter,
                       y = performance,
                       color = as.factor(group_contrast))) + 
  geom_point(alpha = 0.8) +
  geom_segment(data = NULL,
               aes(x = 0.6,
                   xend = 1.4,
                   y = df.prediction$fitted[1],
                   yend = df.prediction$fitted[1]
                   ),
               color = "red",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 1.6,
                   xend = 2.4,
                   y = df.prediction$fitted[2],
                   yend = df.prediction$fitted[2]
                   ),
               color = "orange",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 2.6,
                   xend = 3.4,
                   y = df.prediction$fitted[3],
                   yend = df.prediction$fitted[3]
                   ),
               color = "green",
               size = 1) +
  geom_segment(data = df.augment,
               aes(xend = group_jitter,
                   y = performance,
                   yend = fitted),
               alpha = 0.3) +
  labs(y = "balance") + 
  scale_color_manual(values = c("red", "orange", "green")) + 
  scale_x_continuous(breaks = 1:3, labels = levels(df.contrast$group)) +
  theme(legend.position = "none",
        axis.title.x = element_blank())
```

```{r}

lm(formula = performance ~ group_contrast + I(group_contrast^2),
         data = df.contrast) %>% 
  tidy() %>% 
    head(12) %>% 
    kable(digits = 2) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
  
```

parameter estimates 

```{r}
df.contrast %>% 
  mutate(group_contrast2 = group_contrast^2) %>% 
  group_by(group) %>% 
  filter(row_number() < 4) %>% 
    head(12) %>% 
    kable(digits = 2) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
  
```

constrasts 

```{r}

tibble(
  group = factor(c("3-4", "5-6", "10+"), levels = c("3-4", "5-6", "10+")),
  group_contrast = c(-1, 0, 1),
  group_contrast2 = c(1, 0, 1)
) %>% 
  gather("contrast", "value", -group) %>% 
  spread(group, value) %>% 
    head(10) %>% 
    kable(digits = 0) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
  
lm(formula = performance ~ group_contrast + I(group_contrast^2), 
    data = df.contrast)

```

Results figure

```{r}
df.contrast %>% 
  ggplot(aes(x = group, y = performance)) + 
  geom_point(alpha = 0.3, position = position_jitter(width = 0.1, height = 0)) +
  stat_summary(fun.data = "mean_cl_boot", geom = "linerange", size = 1) + 
  stat_summary(fun.y = "mean", geom = "point", shape = 21, fill = "white", size = 3)
  

```

#### Emmeans 

Planned contrasts: 

```{r}
df.development = df.contrast

library("emmeans")

fit = lm(formula = performance ~ group,
         data = df.development)

# check factor levels 
levels(df.development$group)

# define the contrasts of interest 
contrasts = list(young_vs_old = c(-0.5, -0.5, 1),
                 three_vs_five = c(-1, 1, 0))

# compute estimated marginal means
leastsquare = emmeans(fit, "group")

# run analyses
contrast(leastsquare,
         contrasts,
         adjust = "bonferroni")
```

Post-hoc tests (all pairwise comparisons: 

```{r}
library("emmeans")

fit = lm(formula = performance ~ group,
         data = df.development)

# post hoc tests 
leastsquare = emmeans(fit, "group")
pairs(leastsquare,
      adjust = "bonferroni")
```

```{r}
# fit the model
fit = lm(formula = balance ~ hand + skill,
         data = df.poker)

# post hoc tests 
leastsquare = emmeans(fit, c("hand", "skill"))
pairs(leastsquare,
      adjust = "bonferroni")
```

## Model assumptions 

### Distribution of errors 

#### Data set

```{r}
# make example reproducible 
set.seed(1)

sample_size = 40

b0 = 1
b1 = 5
b2 = 4
sd = 30

df.growth = tibble(
  time = runif(sample_size, min = 0, max = 10),
  growth = b0 + b1*time + b2*time^2 + rnorm(sample_size, sd = sd)
)

```

#### Visualization

Linear model

```{r}
ggplot(df.growth,
       aes(time, growth)) + 
  geom_smooth(method = "lm") + 
  geom_point()
```


```{r}
fit = lm(formula = growth ~ 1 + time, data = df.growth)
```


Linear model with quadratic term 

```{r}
ggplot(df.growth,
       aes(time, growth)) + 
  geom_smooth(method = "lm",
              formula = y ~ x + I(x^2)) + 
  geom_point()
```

```{r}
fit = lm(formula = growth ~ 1 + time + I(time^2), data = df.growth)
fit %>% summary()
```

##### Residual plot

```{r}

fit %>% 
  augment() %>% 
  clean_names() %>% 
ggplot(aes(fitted, resid)) + 
  geom_smooth(method = "lm",
              se = F) +
  geom_point()
```

### Simpsons paradox 

```{r}

b0 = c(1000, 250)
b1 = c(-5, -3)
sample_size = 30
sd = 30

df.simpsons = tibble(
  x = runif(sample_size, min = 75, max = 100),
  y = b0[1] + b1[1] * x + rnorm(sample_size, sd = sd),
  group = 1
) %>% 
  bind_rows(
    tibble(x = runif(sample_size, min = 25, max = 50),
           y = b0[2] + b1[2] * x + rnorm(sample_size, sd = sd),
           group = 2)
  )

```

```{r}
fit.simpson = lm(formula = y ~ x, data = df.simpsons) %>% 
  summary()
```


Plot

```{r}
ggplot(df.simpsons,
       aes(x = x,
           y = y)) +
  geom_smooth(method = "lm") + 
  geom_point()
```

```{r}
ggplot(df.simpsons,
       aes(x = x,
           y = y)) +
  geom_smooth(method = "lm") + 
  geom_smooth(method = "lm",
              aes(group = group,
           color = as.factor(group))) + 
  geom_point() +
  theme(legend.position = "none")
```

Residual plot 

```{r}
fit.simpson = lm(formula = y ~ x, data = df.simpsons)

fit.simpson %>% 
  augment() %>% 
  clean_names() %>% 
  ggplot(aes(fitted, resid)) +
  geom_smooth(method = "lm", se = F) +
  geom_point()
```

## ANOVA afex 

```{r}
library("tidyverse")
library("car")
library("afex")

df.cars = mtcars %>% 
  mutate(index = 1:n()) %>% 
  mutate_at(vars(vs, am), funs(as.factor))

fit1 = lm(formula = mpg ~ vs * am,
         data = df.cars,
         contrasts = list(vs = "contr.sum",
                          am = "contr.sum"))

fit1 %>%
  Anova(type = "3")

fit2 = aov_ez(id = "index",
       dv = "mpg",
       data = df.cars,
       between = c("vs", "am"))
fit2$Anova

```

```{r}
library("car")

lm(formula = balance ~ hand + skill,
   data = df.poker,
   contrasts = list(hand = "contr.sum", 
                    skill = "contr.sum")) %>% 
  Anova(type = "3")
```

## misc 

### PLanned contrasts

```{r}
df.poker %>% 
  mutate(hand_other = ifelse(hand %in% c("neutral", "good"), 1, 0)) %>% 
  select(participant, hand, hand_other, balance) %>% 
  group_by(hand) %>%
           top_n(3) %>% 
           kable(digits = 3) %>% 
           kable_styling(bootstrap_options = "striped",
                       full_width = F) 
  

df.poker %>% 
  mutate(hand_other = ifelse(hand %in% c("neutral", "good"), 1, 0)) %>% 
  lm(balance ~ 1 + hand_other, 
     data = .) %>% 
  summary()
         
# df.poker %>%
#   group_by(hand) %>%
#   summarize(mean = mean(balance)) %>%
#   spread(hand, mean) %>%
#     head(1) %>%
#     kable(digits = 2) %>%
#     kable_styling(bootstrap_options = "striped",
#                 full_width = F)
  
df.poker %>% 
  lm(balance ~ hand,
     data = .,
     contrasts = list(hand = contr.sum)) %>% 
  summary()

df.poker %>% 
lm(balance ~ skill,
     data = .) %>% 
  summary()

```

```{r}
library("emmeans")

# make sure to check the order of levels
df.poker$hand %>% levels()

# define the contrasts of interest 
contrasts = list(bad_rest = c(-1, 0.5, 0.5),
                 neutral_vs_good = c(0, -1, 1))

# compute estimated marginal means
leastsquare = emmeans(fit_a, "hand")

# run follow-up analyses
contrast(leastsquare,
         contrasts,
         adjust = "bonferroni")
  # tidy()%>% 
  #   head(2) %>% 
  #   kable(digits = 2) %>% 
  #   kable_styling(bootstrap_options = "striped",
  #               full_width = F)

df.test = df.poker %>% 
  mutate(code1 = ifelse(hand == "bad", -1, 0.5),
         code2 = ifelse(hand == "bad", 0, NA),
         code2 = ifelse(hand == "neutral", -1, code2),
         code2 = ifelse(hand == "good", 1, code2))

lm(formula = balance ~ code1 + code2,
   data = df.test) %>% 
  summary()



```

```{r}
df.poker %>% 
  group_by(hand) %>% 
  summarize(mean = mean(balance)) %>% 
  spread(hand, mean) %>% 
  mutate(diff_bad_rest = (neutral + good) - bad)
```


```{r}
# lm(formula = balance ~ code1 + code2,
lm(formula = balance ~ hand,
   data = df.poker,
   contrasts = list(hand = "contr.sum")) %>% 
  summary()
```



```{r}
tibble(
  contrast = c("AB vs CD",
               "A vs B",
               "C vs D"),
  A = c(1, 1, 1),
  B = c(1, -1, -1),
  C = c(-1, 1, -1),
  D = c(-1, -1, 1)
) %>% 
  mutate(sum = A + B + C + D) %>% 
  head(3) %>% 
  kable(digits = 1) %>% 
  kable_styling(bootstrap_options = "striped",
              full_width = F)

```


```{r}
tibble(
  contrast = c("Bad vs Rest",
               "Neutral vs Good"),
  Bad = c(-2, 0),
  Neutral = c(1, -1),
  Good = c(1, 1)
) %>% 
  # mutate(sum = Bad + Neutral + Good) %>% 
  head(3) %>% 
  kable(digits = 1) %>% 
  kable_styling(bootstrap_options = "striped",
              full_width = F)

```

```{r}
df.poker %>% 
  # mutate(hand = fct_relevel(hand, "neutral")) %>%
  lm(formula = balance ~ hand * skill,
     data = .,
     contrast = list(hand = "contr.sum", 
                     skill = "contr.sum")) %>% 
  summary()
```

```{r}
df.poker %>% 
  # mutate(hand = fct_relevel(hand, "neutral")) %>%
  lm(formula = balance ~ hand,
     data = .,
     contrast = list(hand = "contr.sum")) %>% 
  summary()
```


```{r}
df.poker %>% 
  group_by(skill) %>% 
  summarize(mean = mean(balance))
```



```{r}
df.poker %>% 
  # mutate(hand = fct_relevel(hand, "neutral")) %>%
  lm(formula = balance ~ hand,
    data = .) %>% 
  summary()

lm(formula = balance ~ hand * skill, data = df.poker,
   contrasts = list(hand = "contr.sum", skill = "contr.sum"))
```



## Additional resources 

### Datacamp 

- [Statistical modeling 1](https://www.datacamp.com/courses/statistical-modeling-in-r-part-1)
- [Statistical modeling 2](https://www.datacamp.com/courses/statistical-modeling-in-r-part-2)
- [Correlation and regression](https://www.datacamp.com/courses/correlation-and-regression)

## Session info 

Information about this R session including which version of R was used, and what packages were loaded. 

```{r session}
sessionInfo()
```

## References