---
title: "Class 12"
author: "Tobias Gerstenberg"
date: "February 4th, 2019"
output:
  bookdown::html_document2:
    toc: true
    toc_depth: 4
    theme: cosmo
    highlight: tango
    pandoc_args: ["--number-offset=9"]
---

```{r setup, include=FALSE}
# these options here change the formatting of how comments are rendered
knitr::opts_chunk$set(
  comment = "",
  results = "hold",
  fig.show = "hold")
```

# Linear model 3

```{r install-packages, include=FALSE, eval=FALSE}
# install.packages("afex")
```

## Load packages and set plotting theme  

```{r load-packages, message=FALSE}
library("knitr")      # for knitting RMarkdown 
library("kableExtra") # for making nice tables
library("janitor")    # for cleaning column names
library("broom")    # for tidying up linear models 
library("afex")    # for running ANOVAs
library("emmeans")    # for calculating constrasts
library("tidyverse")  # for wrangling, plotting, etc. 
```

```{r set-theme}
theme_set(
  theme_classic() + #set the theme 
    theme(text = element_text(size = 20)) #set the default text size
)
```

## Poker data set 

Read in the data:

```{r}
df.poker = read_csv("data/poker.csv") %>% 
  mutate(skill = factor(skill,
                        levels = 1:2,
                        labels = c("expert", "average")),
         skill = fct_relevel(skill, "average", "expert"),
         hand = factor(hand,
                       levels = 1:3,
                       labels = c("bad", "neutral", "good")),
         limit = factor(limit,
                        levels = 1:2,
                        labels = c("fixed", "none")),
         participant = 1:n()) %>% 
  select(participant, everything())

```

Note that the balance is in Euros. 

```{r}
df.poker %>% 
  group_by(skill, hand, limit) %>% 
  filter(row_number() < 3) %>% 
  head(10) %>% 
  kable(digits = 2) %>% 
  kable_styling(bootstrap_options = "striped",
              full_width = F)

```

Visualize the data 

```{r}
df.poker %>% 
  ggplot(mapping = aes(x = hand,
                       y = balance,
                       fill = hand)) + 
  geom_point(alpha = 0.2,
             position = position_jitter(height = 0, width = 0.1)) + 
  stat_summary(fun.data = "mean_cl_boot",
               geom = "linerange",
               size = 1) + 
  stat_summary(fun.y = "mean",
               geom = "point",
               shape = 21,
               size = 4) +
  labs(y = "final balance (in Euros)") + 
  scale_fill_manual(values = c("red", "orange", "green")) +
  theme(legend.position = "none")
  
```


### ANOVA on hand 

```{r}
fit.anova = df.poker %>% 
  aov_ez(id = "participant",
         dv = "balance",
         data = .,
         between = "hand")

fit.anova %>% summary()

```

```{r}
fit.lm = lm(formula = balance ~ hand, 
            data = df.poker)

fit.lm %>% summary()
```

Model comparison 

```{r}
# fit the models 
fit_c = lm(formula = balance ~ 1, data = df.poker)
fit_a = lm(formula = balance ~ hand, data = df.poker)

# compare via F-test
anova(fit_c, fit_a)

fit_a %>% summary()
```





### Visualization

```{r}
set.seed(1)


df.plot = df.poker %>% 
  mutate(hand_jitter = 1 + runif(n(), min = -0.25, max = 0.25))

df.augment = fit_c %>% 
  augment() %>% 
  clean_names() %>% 
  bind_cols(df.plot %>% select(balance, hand, hand_jitter))

ggplot(data = df.plot, 
       mapping = aes(x = hand_jitter,
                       y = balance,
                       fill = hand)) + 
  geom_hline(yintercept = mean(df.poker$balance)) +
  geom_point(alpha = 0.5) + 
  geom_segment(data = df.augment,
               aes(xend = hand_jitter,
                   yend = fitted),
               alpha = 0.2) +
  labs(y = "balance") + 
  theme(legend.position = "none",
        axis.text.x = element_blank(),
        axis.title.x = element_blank())

```


```{r}
set.seed(1)


df.plot = df.poker %>% 
  mutate(hand_jitter = hand %>% as.numeric(),
         hand_jitter = hand_jitter + runif(n(), min = -0.4, max = 0.4))

df.tidy = fit_a %>% 
  tidy() %>% 
  select_if(is.numeric) %>% 
  mutate_all(funs(round, .args = list(digits = 2)))

df.augment = fit_a %>% 
  augment() %>%
  clean_names() %>% 
  bind_cols(df.plot %>% select(hand_jitter))

ggplot(data = df.plot,
       mapping = aes(x = hand_jitter,
                       y = balance,
                       color = hand)) + 
  geom_point(alpha = 0.8) +
  geom_segment(data = NULL,
               aes(x = 0.6,
                   xend = 1.4,
                   y = df.tidy$estimate[1],
                   yend = df.tidy$estimate[1]
                   ),
               color = "red",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 1.6,
                   xend = 2.4,
                   y = df.tidy$estimate[1] + df.tidy$estimate[2],
                   yend = df.tidy$estimate[1] + df.tidy$estimate[2]
                   ),
               color = "orange",
               size = 1) +
  geom_segment(data = NULL,
               aes(x = 2.6,
                   xend = 3.4,
                   y = df.tidy$estimate[1] + df.tidy$estimate[3],
                   yend = df.tidy$estimate[1] + df.tidy$estimate[3]
                   ),
               color = "green",
               size = 1) +
  geom_segment(data = df.augment,
               aes(xend = hand_jitter,
                   y = balance,
                   yend = fitted),
               alpha = 0.3) +
  labs(y = "balance") + 
  scale_color_manual(values = c("red", "orange", "green")) + 
  scale_x_continuous(breaks = 1:3, labels = c("bad", "neutral", "good")) + 
  theme(legend.position = "none",
        axis.title.x = element_blank())
```

Augmented model coefficients: 

```{r}
fit_a %>% 
  tidy() %>% 
    head(4) %>% 
    kable(digits = 3) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
  
```


Calculate PRE

```{r}

df.c = fit_c %>% 
  augment() %>% 
  clean_names() %>% 
  summarize(sse = sum(resid^2) %>% round)

df.a = fit_a %>% 
  augment() %>% 
  clean_names() %>% 
  summarize(sse = sum(resid^2) %>% round)

pre = 1 - df.a$sse/df.c$sse
print(pre %>% round(2))
```


### Dummy coding

```{r}
df.poker = df.poker %>% 
  mutate(hand_neutral = ifelse(hand == "neutral", 1, 0),
         hand_good = ifelse(hand == "good", 1, 0))

fit.tmp = lm(balance ~ 1 + hand_neutral + hand_good, df.poker)

fit.tmp %>% 
  summary()

df.poker %>% 
  select(participant, contains("hand"), balance) %>% 
  group_by(hand) %>% 
  top_n(3) %>% 
  head(10) %>% 
  kable(digits = 3) %>% 
  kable_styling(bootstrap_options = "striped",
              full_width = F)



```

### Effect coding 

```{r}
df.poker %>% 
  lm(balance ~ hand,
     data = .,
     contrasts = list(hand = contr.treatment)) %>% 
  summary()
```

```{r}
df.poker %>% 
  lm(balance ~ hand,
     data = .,
     contrasts = list(hand = contr.sum)) %>% 
  summary()

df.poker %>% 
  mutate(hand_neutral = ifelse(hand == "neutral", -1, 0),
         hand_good = ifelse(hand == "good", 1, 0))
```

Follow-up questions:

```{r}
df.poker %>% 
  filter(hand %in% c("bad", "neutral")) %>% 
  lm(formula = balance ~ hand, 
     data = .) %>% 
  summary()
```

```{r}
df.poker %>% 
  filter(hand %in% c("neutral", "good")) %>% 
  lm(formula = balance ~ hand, 
     data = .) %>% 
  summary()
```

```{r}
df.poker %>% 
  mutate(hand = fct_relevel(hand, "neutral")) %>% 
  lm(formula = balance ~ hand,
     data = .) %>% 
  summary()
```

### PLanned contrasts

```{r}
df.poker %>% 
  mutate(hand_other = ifelse(hand %in% c("neutral", "good"), 1, 0)) %>% 
  select(participant, hand, hand_other, balance) %>% 
  group_by(hand) %>%
           top_n(3) %>% 
           kable(digits = 3) %>% 
           kable_styling(bootstrap_options = "striped",
                       full_width = F) 
  

df.poker %>% 
  mutate(hand_other = ifelse(hand %in% c("neutral", "good"), 1, 0)) %>% 
  lm(balance ~ 1 + hand_other, 
     data = .) %>% 
  summary()
         
# df.poker %>%
#   group_by(hand) %>%
#   summarize(mean = mean(balance)) %>%
#   spread(hand, mean) %>%
#     head(1) %>%
#     kable(digits = 2) %>%
#     kable_styling(bootstrap_options = "striped",
#                 full_width = F)
  
df.poker %>% 
  lm(balance ~ hand,
     data = .,
     contrasts = list(hand = contr.sum)) %>% 
  summary()

df.poker %>% 
lm(balance ~ skill,
     data = .) %>% 
  summary()

```

```{r}
library("emmeans")

# make sure to check the order of levels
df.poker$hand %>% levels()

# define the contrasts of interest 
contrasts = list(bad_rest = c(-1, 0.5, 0.5),
                 neutral_vs_good = c(0, -1, 1))

# compute estimated marginal means
leastsquare = emmeans(fit_a, "hand")

# run follow-up analyses
contrast(leastsquare,
         contrasts,
         adjust = "bonferroni")
  # tidy()%>% 
  #   head(2) %>% 
  #   kable(digits = 2) %>% 
  #   kable_styling(bootstrap_options = "striped",
  #               full_width = F)

df.test = df.poker %>% 
  mutate(code1 = ifelse(hand == "bad", -1, 0.5),
         code2 = ifelse(hand == "bad", 0, NA),
         code2 = ifelse(hand == "neutral", -1, code2),
         code2 = ifelse(hand == "good", 1, code2))

lm(formula = balance ~ code1 + code2,
   data = df.test) %>% 
  summary()



```

```{r}
df.poker %>% 
  group_by(hand) %>% 
  summarize(mean = mean(balance)) %>% 
  spread(hand, mean) %>% 
  mutate(diff_bad_rest = (neutral + good) - bad)
```


```{r}
# lm(formula = balance ~ code1 + code2,
lm(formula = balance ~ hand,
   data = df.poker,
   contrasts = list(hand = "contr.sum")) %>% 
  summary()
```



```{r}
tibble(
  contrast = c("AB vs CD",
               "A vs B",
               "C vs D"),
  A = c(1, 1, 1),
  B = c(1, -1, -1),
  C = c(-1, 1, -1),
  D = c(-1, -1, 1)
) %>% 
  mutate(sum = A + B + C + D) %>% 
  head(3) %>% 
  kable(digits = 1) %>% 
  kable_styling(bootstrap_options = "striped",
              full_width = F)

```


```{r}
tibble(
  contrast = c("Bad vs Rest",
               "Neutral vs Good"),
  Bad = c(-2, 0),
  Neutral = c(1, -1),
  Good = c(1, 1)
) %>% 
  # mutate(sum = Bad + Neutral + Good) %>% 
  head(3) %>% 
  kable(digits = 1) %>% 
  kable_styling(bootstrap_options = "striped",
              full_width = F)

```

```{r}
df.poker %>% 
  # mutate(hand = fct_relevel(hand, "neutral")) %>%
  lm(formula = balance ~ hand * skill,
     data = .,
     contrast = list(hand = "contr.sum", 
                     skill = "contr.sum")) %>% 
  summary()
```

```{r}
df.poker %>% 
  # mutate(hand = fct_relevel(hand, "neutral")) %>%
  lm(formula = balance ~ hand,
     data = .,
     contrast = list(hand = "contr.sum")) %>% 
  summary()
```


```{r}
df.poker %>% 
  group_by(skill) %>% 
  summarize(mean = mean(balance))
```



```{r}
df.poker %>% 
  # mutate(hand = fct_relevel(hand, "neutral")) %>%
  lm(formula = balance ~ hand,
    data = .) %>% 
  summary()

lm(formula = balance ~ hand * skill, data = df.poker,
   contrasts = list(hand = "contr.sum", skill = "contr.sum"))
```



## Two-way ANOVA 

### Group means


```{r}
df.poker %>% 
  group_by(skill) %>% 
  summarize(mean = mean(balance),
            sd = sd(balance)) %>% 
    head(4) %>% 
    kable(digits = 2) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
  
```

```{r}
df.poker %>% 
  group_by(hand) %>% 
  summarize(mean = mean(balance)) %>% 
  spread(hand, mean) %>% 
    head(4) %>% 
    kable(digits = 2) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
```




```{r}
df.poker %>% 
  group_by(skill, hand) %>% 
  summarize(mean = mean(balance)) %>% 
  spread(hand, mean) %>% 
    head(2) %>% 
    kable(digits = 2) %>% 
    kable_styling(bootstrap_options = "striped",
                full_width = F)
```


### Plots 

```{r}
ggplot(data = df.poker,
       mapping = aes(x = hand,
                     y = balance,
                     group = skill,
                     fill = hand)) +
  geom_point(position = position_jitterdodge(jitter.width = 0.3,
                                             jitter.height = 0,
                                             dodge.width = 0.9),
             alpha = 0.2) + 
  stat_summary(fun.data = "mean_cl_boot",
               geom = "linerange",
               color = "black",
               position = position_dodge(0.9)) + 
  stat_summary(fun.y = "mean",
               geom = "point",
               aes(shape = skill),
               color = "black",
               position = position_dodge(0.9),
               size = 3) +
  scale_fill_manual(values = c("red", "orange", "green")) +
  scale_shape_manual(values = c(21, 22)) +
  guides(fill = F)
  
```


```{r}
ggplot(data = df.poker,
       mapping = aes(x = skill,
                     y = balance)) +
  geom_point(position = position_jitter(width = 0.2,
                                             height = 0),
             alpha = 0.2) + 
  stat_summary(fun.data = "mean_cl_boot",
               geom = "linerange",
               color = "black",
               position = position_dodge(0.9)) + 
  stat_summary(fun.y = "mean",
               geom = "point",
               color = "black",
               position = position_dodge(0.9),
               aes(shape = skill),
               size = 3,
               fill = "black") +
  # scale_fill_manual(values = c("red", "orange", "green")) +
  scale_shape_manual(values = c(21, 22)) +
  guides(shape = F)
  
```

### Analysis of variance


```{r}
lm(formula = balance ~ hand * skill, data = df.poker) %>% 
  anova()
  # tidy() %>% 
  #   head(4) %>% 
  #   kable(digits = 2) %>% 
  #   kable_styling(bootstrap_options = "striped",
  #               full_width = F)
  
```

```{r}
aov_ez(id = "participant",
       dv = "balance",
       data = df.poker,
       between = c("hand", "skill")
)
```

```{r}
aov(balance ~ hand * skill, data = df.poker)
```



```{r}
lm(formula = balance ~ hand * skill,
   data = df.poker,
   contrasts = list(hand = contr.sum,
                    skill = contr.sum)) %>% 
  summary()

```

### Interpreting interactions 

```{r}
set.seed(1)

b0 = 15
nsamples = 30
sd = 5

b1 = 1
b2 = 1
b1_2 = 1


# main effect of condition
# b1 = 10 
# b2 = 1 
# b1_2 = 1

# two main effects
# b1 = 5
# b2 = -5
# b1_2 = 0
 
# interaction effect
# b1 = 10
# b2 = 10
# b1_2 = -20

# interaction and main effect
# b1 = 10
# b2 = 0
# b1_2 = -20

# all three
# b1 = 2
# b2 = 2
# b1_2 = 10

df.data = tibble(
  condition = rep(c(0, 1), each = nsamples),
  treatment = rep(c(0, 1), nsamples),
  rating = b0 + b1 * condition + b2 * treatment + (b1_2 * condition * treatment) + rnorm(nsamples, sd = sd)) %>%
  mutate(condition = factor(condition, labels = c("A", "B")),
  treatment = factor(treatment, labels = c("1", "2")))

ggplot(df.data,
       aes(x = condition,
           y = rating,
           group = treatment,
           fill = treatment)) + 
  stat_summary(fun.y = "mean",
               geom = "bar",
               color = "black",
               position = position_dodge(0.9)) +
  stat_summary(fun.data = "mean_cl_boot",
               geom = "linerange",
               size = 1,
               position = position_dodge(0.9)) +
  scale_fill_brewer(palette = "Set1")

# ggsave("figures/main_effect.png", width = 8, height = 6)
# ggsave("figures/two_main_effects.png", width = 8, height = 6)
# ggsave("figures/interaction.png", width = 8, height = 6)
# ggsave("figures/all_three.png", width = 8, height = 6)
# ggsave("figures/interaction_main.png", width = 8, height = 6)
# ggsave("figures/no_effects.png", width = 8, height = 6)

# lm(formula = rating ~ condition * treatment,
#   data = df.data) %>%
#   anova() %>%
#   tidy() %>%
#   mutate(significant = p.value < .01)

```



## Additional resources 

### Datacamp 

- [Statistical modeling 1](https://www.datacamp.com/courses/statistical-modeling-in-r-part-1)
- [Statistical modeling 2](https://www.datacamp.com/courses/statistical-modeling-in-r-part-2)
- [Correlation and regression](https://www.datacamp.com/courses/correlation-and-regression)

## Session info 

Information about this R session including which version of R was used, and what packages were loaded. 

```{r session}
sessionInfo()
```